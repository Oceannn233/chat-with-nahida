<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>是最最可爱的纳西妲呀~</title>
    <style>
        * { box-sizing: border-box; }
        :root { --nahida-green-light: #a8e063; --nahida-green-dark: #56ab2f; --background-blur: 12px; --background-opacity: 0.9; }
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans SC', sans-serif; margin: 0; background-image: url('/static/nahi_background.png'); background-size: cover; background-position: center; background-attachment: fixed; overflow: hidden; }
        .main-container { display: flex; width: 100vw; height: 100vh; }
        .sidebar { width: 260px; height: 100%; background-color: rgba(240, 248, 240, 0.9); backdrop-filter: blur(var(--background-blur)); border-right: 1px solid rgba(0,0,0,0.1); display: flex; flex-direction: column; transition: transform 0.3s ease-in-out; transform: translateX(0); position: absolute; z-index: 100; }
        .sidebar.collapsed { transform: translateX(-100%); }
        .sidebar-header { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.08); gap: 10px; }
        .new-chat-btn { background: linear-gradient(135deg, var(--nahida-green-light), var(--nahida-green-dark)); color: white; border: none; padding: 8px 15px; border-radius: 20px; font-size: 0.9em; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; flex-grow: 1; justify-content: center; }
        .sidebar-footer { padding: 10px; border-top: 1px solid rgba(0,0,0,0.08); }
        .clear-history-btn { width: 100%; background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 8px; border-radius: 8px; cursor: pointer; }
        .icon-button { background: none; border: none; font-size: 1.5em; cursor: pointer; color: #555; padding: 5px; border-radius: 50%; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; }
        .icon-button:hover { background-color: rgba(0,0,0,0.1); }
        .history-list { flex-grow: 1; overflow-y: auto; padding: 10px; }
        .history-item { padding: 12px 15px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; position: relative; }
        .history-item:hover { background-color: rgba(0,0,0,0.05); }
        .history-item.active { background-color: #d0e8d0; font-weight: bold; }
        .delete-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; display: none; font-size: 1.2em; color: #888; }
        .history-item:hover .delete-btn { display: block; }
        .delete-btn:hover { color: red; }
        .chat-wrapper { flex-grow: 1; height: 100vh; display: flex; justify-content: center; align-items: center; padding: 2vh 2vw; transition: margin-left 0.3s ease-in-out; }
        .chat-container { width: 100%; height: 100%; background-color: rgba(255, 255, 255, var(--background-opacity)); backdrop-filter: blur(var(--background-blur)); border-radius: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.15); display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .chat-header { background: linear-gradient(135deg, var(--nahida-green-light), var(--nahida-green-dark)); color: white; padding: 12px 15px; text-align: center; font-size: 1.4em; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .header-button-main { background: none; border: none; color: white; cursor: pointer; width: 44px; height: 44px; display: flex; justify-content: center; align-items: center; border-radius: 50%; }
        .header-button-main:hover { background-color: rgba(255,255,255,0.2); }
        .header-button-main svg { width: 24px; height: 24px; }
        .chat-box { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 25px; }
        .message-wrapper { display: flex; align-items: flex-start; gap: 10px; max-width: 90%; }
        .message-wrapper.user { align-self: flex-end; flex-direction: row-reverse; }
        .message-wrapper.assistant { align-self: flex-start; flex-direction: row; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 2px solid var(--nahida-green-light); box-shadow: 0 0 5px rgba(0,0,0,0.1); }
        .message-bubble { display: flex; flex-direction: column; align-items: flex-start; gap: 15px; }
        .message-content { padding: 12px 18px; border-radius: 22px; line-height: 1.6; word-wrap: break-word; font-size: 1em; box-shadow: 0 2px 8px rgba(0,0,0,0.08); min-height: 1.6em; }
        .message-wrapper.user .message-content { background-color: #007bff; color: white; border-bottom-right-radius: 8px; }
        .message-wrapper.assistant .message-content { background-color: #e6ffe6; color: #333; border-bottom-left-radius: 8px; }
        .message-image { max-width: 100%; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); cursor: pointer; transition: transform 0.3s ease, opacity 0.5s ease; opacity: 0; }
        .message-image.loaded { opacity: 1; }
        .image-placeholder { color: #888; font-style: italic; font-size: 0.9em; padding-top: 5px;} /* 新增：图片加载占位符 */
        .chat-input { display: flex; border-top: 1px solid #eee; padding: 15px; background-color: rgba(255, 255, 255, 0.95); }
        #message-input { flex-grow: 1; border: 1px solid #ccc; border-radius: 25px; padding: 12px 18px; font-size: 1.05em; outline: none; transition: border-color 0.3s, box-shadow 0.3s; box-shadow: inset 0 1px 3px rgba(0,0,0,0.06); }
        #send-button { background: linear-gradient(45deg, var(--nahida-green-light), var(--nahida-green-dark)); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; margin-left: 12px; cursor: pointer; transition: all 0.2s ease-out; display: flex; justify-content: center; align-items: center; box-shadow: 0 3px 10px rgba(0,0,0,0.1); flex-shrink: 0; }
        #send-button.stop-mode { background: #6c757d; }
        #send-button:disabled:not(.stop-mode) { background: #cccccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="sidebar collapsed" id="sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" id="new-chat-btn-sidebar">➕ 新对话</button>
                <button class="icon-button" id="sidebar-collapse-btn" title="收起侧边栏">‹</button>
            </div>
            <div class="history-list" id="history-list"></div>
            <div class="sidebar-footer">
                <button class="clear-history-btn" id="clear-history-btn">清空所有历史</button>
            </div>
        </div>

        <div class="chat-wrapper" id="chat-wrapper">
            <div class="chat-container">
                <div class="chat-header">
                    <button class="header-button-main" id="sidebar-toggle-btn" title="历史会话">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg>
                    </button>
                    <span>是最最可爱的纳西妲呀~</span>
                    <button class="header-button-main" id="new-chat-btn-header" title="新对话">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>
                    </button>
                </div>
                <div class="chat-box" id="chat-box">
                    <div class="messages" id="messages"></div>
                </div>
                <form class="chat-input" id="chat-form">
                    <input type="text" id="message-input" placeholder="输入消息..." autocomplete="off" required>
                    <button id="send-button" type="submit"></button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const messagesContainer = document.getElementById('messages');
        const chatBox = document.getElementById('chat-box');
        const sendButton = document.getElementById('send-button');
        const newChatBtnHeader = document.getElementById('new-chat-btn-header');
        const newChatBtnSidebar = document.getElementById('new-chat-btn-sidebar');
        const historyList = document.getElementById('history-list');
        const sidebar = document.getElementById('sidebar');
        const chatWrapper = document.getElementById('chat-wrapper');
        const sidebarCollapseBtn = document.getElementById('sidebar-collapse-btn');
        const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        
        const sendIconSVG = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>`;
        const stopIconSVG = `<svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12"></rect></svg>`;

        let sessions = {};
        let activeSessionId = null;
        let currentAudio = null;
        let typewriterInterval = null;
        let abortController = null;

        window.onload = () => {
            sendButton.innerHTML = sendIconSVG;
            loadSessions();
            if (!activeSessionId || !sessions[activeSessionId]) {
                startNewChat(false);
            } else {
                loadSession(activeSessionId);
            }
            renderHistoryList();
            toggleSidebar(true);
        };

        chatForm.addEventListener('submit', handleSendMessage);
        newChatBtnHeader.addEventListener('click', () => startNewChat(true));
        newChatBtnSidebar.addEventListener('click', () => startNewChat(true));
        sidebarCollapseBtn.addEventListener('click', () => toggleSidebar(true));
        sidebarToggleBtn.addEventListener('click', () => toggleSidebar(false));
        clearHistoryBtn.addEventListener('click', clearAllHistory);

        async function handleSendMessage(e) {
            e.preventDefault();
            if (sendButton.classList.contains('stop-mode')) {
                stopGeneration();
                return;
            }
            const messageText = messageInput.value.trim();
            if (!messageText || sendButton.disabled) return;
            
            messageInput.value = '';
            stopCurrentAudio();
            updateHistoryAndUI(messageText, 'user');
            const assistantMessageWrapper = addMessage({ text: "..." }, 'assistant');
            
            enableInput(false);
            setSendButtonMode('stop');

            abortController = new AbortController();
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        message: messageText,
                        history: sessions[activeSessionId] ? sessions[activeSessionId].slice(1) : []
                    }),
                    signal: abortController.signal
                });
                await processStreamResponse(response, assistantMessageWrapper);
            } catch (error) {
                 if (error.name === 'AbortError') {
                     updateAssistantMessage(assistantMessageWrapper.querySelector('.message-content'), '[对话已中断]');
                 } else {
                     console.error('Connection failed:', error);
                     updateAssistantMessage(assistantMessageWrapper.querySelector('.message-content'), `连接错误: ${error.message}`);
                 }
                 enableInput(true);
                 setSendButtonMode('send');
            }
        }
        
        async function processStreamResponse(response, wrapper) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
        
            // 使用两个变量来独立管理音频和图片的状态
            let receivedImageURL = null;
            let isAudioFinished = false;

            // 创建一个函数，用于在条件满足时显示图片
            const showImageWhenReady = () => {
                if (receivedImageURL && isAudioFinished) {
                    appendImageToBubble(wrapper.querySelector('.message-bubble'), receivedImageURL);
                    receivedImageURL = null; // 显示后重置
                }
            };

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                buffer += decoder.decode(value, { stream: true });
                let boundary = buffer.indexOf('\n\n');

                while (boundary !== -1) {
                    const message = buffer.substring(0, boundary);
                    buffer = buffer.substring(boundary + 2);
                    if (message.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(message.substring(6));
                            handleServerEvent(data, wrapper, {
                                // 将状态变量和检查函数传递下去
                                onAudioEnd: () => { 
                                    isAudioFinished = true;
                                    showImageWhenReady(); // 音频结束时，尝试显示图片
                                },
                                onImageReceived: (url) => {
                                    receivedImageURL = url;
                                    showImageWhenReady(); // 收到图片时，尝试显示图片
                                }
                            });
                        } catch (e) { console.error("Failed to parse SSE data chunk: ", message); }
                    }
                    boundary = buffer.indexOf('\n\n');
                }
            }
        }

        function handleServerEvent(data, wrapper, callbacks) {
            const { onAudioEnd, onImageReceived } = callbacks;

            switch (data.type) {
                case 'content_start':
                    const bubble = wrapper.querySelector('.message-bubble');
                    // 添加图片加载占位符
                    const placeholder = document.createElement('div');
                    placeholder.className = 'image-placeholder';
                    placeholder.textContent = '正在描绘图片...';
                    bubble.appendChild(placeholder);

                    if (data.audio) {
                        currentAudio = new Audio(`data:audio/mp3;base64,${data.audio}`);
                        currentAudio.onloadedmetadata = () => {
                            typewriter(wrapper.querySelector('.message-content'), data.text, currentAudio.duration * 1000);
                        };
                        currentAudio.onended = onAudioEnd;
                        currentAudio.play().catch(e => console.error("Audio playback failed:", e));
                    } else {
                        updateAssistantMessage(wrapper.querySelector('.message-content'), data.text);
                        onAudioEnd(); // 没有音频，直接触发结束事件
                    }
                    break;
                case 'image':
                    onImageReceived(data.payload); // 收到图片，通知处理器
                    break;
                case 'done':
                    const finalImageUrl = wrapper.querySelector('.message-image')?.src || null;
                    const assistantReply = {
                        text: data.full_response,
                        image_url: finalImageUrl
                    };
                    sessions[activeSessionId].push({ role: 'assistant', content: assistantReply });
                    saveSessions();
                    renderHistoryList();
                    enableInput(true);
                    setSendButtonMode('send');
                    break;
                case 'error':
                    updateAssistantMessage(wrapper.querySelector('.message-content'), `Server Error: ${data.content}`);
                    enableInput(true);
                    setSendButtonMode('send');
                    break;
            }
        }
        
        function appendImageToBubble(bubble, imageUrl) {
            // 移除图片加载占位符
            const placeholder = bubble.querySelector('.image-placeholder');
            if(placeholder) placeholder.remove();

            const image = document.createElement('img');
            image.src = imageUrl;
            image.alt = "Generated Image";
            image.className = 'message-image';
            image.onload = () => { 
                image.classList.add('loaded');
                chatBox.scrollTop = chatBox.scrollHeight; 
            };
            bubble.appendChild(image);
        }

        function stopGeneration() { if (abortController) { abortController.abort(); } stopCurrentAudio(); }
        function setSendButtonMode(mode) { if (mode === 'stop') { sendButton.innerHTML = stopIconSVG; sendButton.classList.add('stop-mode'); } else { sendButton.innerHTML = sendIconSVG; sendButton.classList.remove('stop-mode'); } }
        function typewriter(element, text, duration) { element.textContent = ""; let i = 0; const textLength = text.length; let speed = Math.max(30, Math.min(150, duration / textLength)); typewriterInterval = setInterval(() => { if (i < textLength) { element.textContent += text.charAt(i++); chatBox.scrollTop = chatBox.scrollHeight; } else { clearInterval(typewriterInterval); typewriterInterval = null; } }, speed); }
        function stopCurrentAudio() { if (currentAudio) { currentAudio.pause(); currentAudio.currentTime = 0; currentAudio = null; } if(typewriterInterval) { clearInterval(typewriterInterval); typewriterInterval = null; } }
        function startNewChat(collapseSidebar = false) { stopGeneration(); const newId = Date.now().toString(); sessions[newId] = [{"role": "system", "content": "New Chat"}]; activeSessionId = newId; messagesContainer.innerHTML = ''; saveSessions(); renderHistoryList(); enableInput(true); setSendButtonMode('send'); if (collapseSidebar) { toggleSidebar(true); } }
        function loadSession(sessionId) { if (!sessions[sessionId] || activeSessionId === sessionId) return; stopGeneration(); activeSessionId = sessionId; messagesContainer.innerHTML = ''; sessions[sessionId].slice(1).forEach(item => { const contentData = (typeof item.content === 'string') ? { text: item.content } : item.content; addMessage(contentData, item.role); }); saveSessions(); renderHistoryList(); chatBox.scrollTop = chatBox.scrollHeight; }
        function deleteSession(sessionId, event) { event.stopPropagation(); if (confirm("确定要删除这个会话吗？")) { delete sessions[sessionId]; if (activeSessionId === sessionId) { startNewChat(false); } else { saveSessions(); renderHistoryList(); } } }
        function clearAllHistory() { if (confirm("确定要清空所有历史记录吗？此操作不可撤销。")) { sessions = {}; localStorage.removeItem('nahidaChatSessions'); startNewChat(false); } }
        function renderHistoryList() { historyList.innerHTML = ''; Object.keys(sessions).sort().reverse().forEach(id => { const item = document.createElement('div'); item.className = 'history-item'; item.dataset.id = id; if (id === activeSessionId) item.classList.add('active'); const firstUserMessage = sessions[id].find(m => m.role === 'user'); item.textContent = firstUserMessage ? (typeof firstUserMessage.content === 'string' ? firstUserMessage.content : firstUserMessage.content.text) : '新的对话'; const deleteBtn = document.createElement('button'); deleteBtn.className = 'delete-btn'; deleteBtn.innerHTML = '×'; deleteBtn.onclick = (event) => deleteSession(id, event); item.appendChild(deleteBtn); item.onclick = () => loadSession(id); historyList.appendChild(item); }); }
        function enableInput(isEnabled) { sendButton.disabled = !isEnabled; messageInput.disabled = !isEnabled; if (isEnabled) messageInput.focus(); }
        function updateHistoryAndUI(text, role) { const content = { text }; sessions[activeSessionId].push({ role, content }); addMessage(content, role); saveSessions(); }
        function loadSessions() { const data = localStorage.getItem('nahidaChatSessions'); if (data) { const parsedData = JSON.parse(data); sessions = parsedData.sessions || {}; activeSessionId = parsedData.activeSessionId; } }
        function saveSessions() { const data = { sessions: sessions, activeSessionId: activeSessionId }; localStorage.setItem('nahidaChatSessions', JSON.stringify(data)); }
        function addMessage(data, role) { const wrapper = document.createElement('div'); wrapper.classList.add('message-wrapper', role); const avatar = document.createElement('img'); avatar.classList.add('avatar'); avatar.src = (role === 'user') ? '/static/user_icon.png' : '/static/nahi_icon.jpeg'; const bubble = document.createElement('div'); bubble.classList.add('message-bubble'); const content = document.createElement('div'); content.classList.add('message-content'); content.textContent = data.text; bubble.appendChild(content); if (data.image_url) { appendImageToBubble(bubble, data.image_url); } wrapper.appendChild(avatar); wrapper.appendChild(bubble); messagesContainer.appendChild(wrapper); chatBox.scrollTop = chatBox.scrollHeight; return wrapper; }
        function updateAssistantMessage(element, text) { element.textContent = text; chatBox.scrollTop = chatBox.scrollHeight; }
        function toggleSidebar(collapse) { sidebar.classList.toggle('collapsed', collapse); chatWrapper.style.marginLeft = collapse ? '0' : '260px'; }
    </script>
</body>
</html>